---
title: "Philippine Tech Hackers Salary Survey, part 1"
output:
  html_document: 
    toc: true
    includes:
      in_header: meta_headers.html
    template: default_template.html
  
---


```{r intro, echo=FALSE, message=FALSE}
library(doMC)
registerDoMC(cores = 5)
library(tidyverse)
library(scales)  # allows us to use labels=comma in scales

source("salary_survey_util.R")

# read_csv is a tidyverse version, found in the readr library
phackers_raw <- read_csv("Philippine Tech Hackers Salary Survey 2017.csv")
phackers <- preprocess_salary_survey(phackers_raw)
#summary(phackers$salary_numeric)
#print(paste("Total non-outlier respondents: ", dim(phackers)[1]))

salary_median <- median(phackers$salary_numeric)

Php <- function(x) {
  sprintf("Php %s", comma(x))
}

PhpK <- function(x) {
  Php(x/1000)
}
```

# Introduction

The second Philippine Tech Hackers Salary Survey was conducted online using Google Forms. 
A total of `r nrow(phackers_raw)` community members responded, from companies both large and small, and from a wide variety of
industries. Respondents were mostly software developers, but other professionals who program and are involved in IT also participated. Outliers, and those who reported as living/working outside the country were excluded from the analysis.

The median monthly base salary for the remaining sample was `r Php(median(phackers$salary_numeric))`, with the middle half of all respondents earning between `r Php(quantile(phackers$salary_numeric, 0.25))` and `r Php(quantile(phackers$salary_numeric, 0.75))` 

_In the horizontal bar charts throughout this report, we include the interquartile range (IQR) to show the middle 50% of respondentsâ€™ answers to questions such as salary. One quarter of the respondents has a salary below the displayed range, and one quarter has a salary above the displayed range. The median salary of `r Php(median(phackers$salary_numeric))` will be represented in the box graphs by a dashed blue line._

```{r intro_plot, echo=FALSE, message=FALSE}
intro_plot <- ggplot(phackers, aes(salary_level, fill=..count..))  + 
  geom_bar() +  
  geom_vline(xintercept=47500, linetype="dashed", color="blue") + 
  labs(title="Total Salary", x="Total Salary (Php)", y="Respondents") +
  guides(fill = "none") +
  coord_flip() 


intro_plot
```

# Location

```{r location, echo=FALSE}
phackers_in_ph <- phackers %>%  filter(!is.na(ncr))
location_summary <-  phackers_in_ph %>% 
  group_by(ncr) %>% 
  summarise(Median=median(salary_numeric), n=n(), 
            pct=n()/sum(count(phackers_in_ph)), 
            ymin=quantile(salary_numeric, 0.25), 
            ymax=quantile(salary_numeric, 0.75))

median_salary_ncr <- location_summary$Median[location_summary$ncr == "NCR"]
percentage_outside_ncr <- location_summary$pct[location_summary$ncr != "NCR"]
median_salary_outside_ncr <- location_summary$Median[location_summary$ncr != "NCR"]
ncr_salary_premium <- median_salary_ncr - median_salary_outside_ncr
```

The overwhelming majority of respondents live and work in Metro Manila, with just over `r percent(percentage_outside_ncr)` of the respondents from other cities in the Philippines. 
The median salary for respondents living and working in Metro Manila is `r Php(median_salary_ncr)` with the median outside of NCR `r Php(ncr_salary_premium)` lower at `r Php(median_salary_outside_ncr)`

```{r location-plot, echo=FALSE}
location_lineplot <- location_summary %>% ggplot(aes(x=ncr, y=Median, ymin=ymin, ymax=ymax, fill=ncr)) + 
  median_hline + 
  geom_crossbar(alpha=0.5, color="white") +
   # geom_point(shape='|', size=10,stroke=2, color="white" )  +
  labs(title="Location", x="Location", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()

location_lineplot

# location_boxplot <- phackers_in_ph %>% ggplot(aes(x=ncr, y=salary_numeric, fill=ncr)) + 
#   median_hline + 
#   geom_boxplot() + 
#   labs(x="Location", y="Salary Range", title="Location") +
#   guides(fill="none") + 
#   coord_flip()
# location_plot
```

# Company Types 

```{r company_types, echo=FALSE}
phackers_employed <- phackers %>% filter(employment_f=="Employed")

# Determine the top 10 industries represented
top_industry_employed <- phackers_employed %>% 
  group_by(company_industry_f) %>% 
  summarise(median=median(salary_numeric), n=n(), pct=n()/sum(count(phackers))) %>% 
  arrange(desc(pct)) %>%
  rename("Industry"=company_industry_f, percentage=pct) %>% 
  top_n(n=10, wt=percentage)
```
The salary survey included questions on industry, company size, and company age. Software was the most well-represented industry (`r percent(top_industry_employed$percentage[1])`), followed by IT Consulting (`r percent(top_industry_employed$percentage[2])`) and Business Process Outsourcing (`r percent(top_industry_employed$percentage[3])`). 

## Industry Salaries

In terms of salary range, employees in Banking/Finance, Advertising/Marketing/PR and Carriers/Telecommunications 
had the highest median salary ranges at Php 57,000 while
Education had the lowest at Php 32,500 or Php 15,000 below the overall median of `r Php(salary_median)`.

```{r industry, echo=FALSE, message=FALSE}


# Use inner_join to get the subset phackers in the top 10 industries
# inner_join(phackers_employed, top_industry_employed, by=c("company_industry_f" = "Industry")) %>% 
#   group_by(company_industry_f) %>%
#   summarise(median(salary_numeric))

top_industry_phackers <- tbl_df(inner_join(phackers_employed, top_industry_employed, by=c("company_industry_f" = "Industry")) )

industry_boxplot <- top_industry_phackers %>% 
  ggplot(aes(x=company_industry_f, y=salary_numeric, fill=company_industry_f)) + 
  geom_boxplot() + 
  median_hline + 
  labs(title="Top 10 Industries by number of respondents", x="Industry", y="Salary Range") +
  guides(fill="none")  +
  coord_flip() 

top_industry_phackers %>% group_by(company_industry_f) %>% summarise(median_salary=median(salary_numeric), lower=quantile(salary_numeric, 0.25), upper=quantile(salary_numeric, 0.75)) %>%
  ggplot(aes(x=company_industry_f, fill=company_industry_f, y=median_salary, ymin=lower, ymax=upper)) + 
  median_hline + 
  # geom_linerange(size=5) +
  geom_crossbar(alpha=0.5, color="white") + 
  # geom_point(shape='|', size=5, stroke=2, color="white" )  +
  labs(title="Company Industry", x="Company Industry", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
```

## Company Size 

Half the respondents work in companies with 100 or less employees, with 22.44% of respondents working in companies with between 2 and 25 employees. Respondents working in very large companies (over 10,000 employees) made up only 7.56% of the sample. 

Both very small and very large companies had median salaries below the overall median of Php 47,500 with the smallest companies paying the least.  

```{r company_size, echo=FALSE}

company_size_summary <-phackers_employed %>%
  group_by(company_size_f) %>% 
  summarise(median_salary=median(salary_numeric), n = n(), pct = round(100 * n() / sum(count(phackers)), 2),
            lower=quantile(salary_numeric, 0.25), 
            upper=quantile(salary_numeric, 0.75))

company_size_boxplot <- phackers_employed %>% 
  ggplot(aes(y=salary_numeric, x=company_size_f, fill=company_size_f)) + 
  median_hline + 
  geom_boxplot(outlier.alpha = 0.2) + 
  labs(title="Company Size", x="Company Size", y="Salary Range") + 
  guides(fill="none") +
  coord_flip()  

company_size_summary %>% ggplot(aes(x=company_size_f, y=median_salary, ymin=lower, ymax=upper, fill=company_size_f )) + 
  median_hline + 
  geom_crossbar(alpha=0.5, color="white") + 
  # geom_linerange(size=5) +
  # geom_point(shape='|', size=5, stroke=2, color="white" )  +
  labs(title="Company Size", x="Company Size", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
```

## Company Age

Employees working at companies less than 5 years old made up 35.56% of respondents and reported salaries slightly above the overall median, while those working at companies that had been in operations over 20 years reported salaries below the overall median.

```{r company_age, echo=FALSE}
company_age_summary <- phackers_employed %>%
  group_by(company_age_f) %>% 
  summarise(median_salary=median(salary_numeric), n(), 
            pct=round(100 * n()/sum(count(phackers)), 2), 
            lower=quantile(salary_numeric, 0.25),
            upper=quantile(salary_numeric, 0.75))
# company_age_summary

company_age_boxplot <- phackers_employed %>% 
  ggplot(aes(x=company_age_f, y=salary_numeric, fill=company_age_f)) + 
  median_hline +
  geom_boxplot(outlier.alpha="0") +
  labs(x="Company age", y="Salary Range", title="Company Age") +
  guides(fill="none") +
  coord_flip() 

company_age_summary %>% ggplot(aes(x=company_age_f, fill=company_age_f, y=median_salary, ymin=lower, ymax=upper)) + 
  median_hline +
  geom_crossbar(alpha=0.5, color="white") +
  # geom_linerange(size=5) +
  # geom_point(shape='|', size=5, stroke=2, color="white" )  +
  labs(title="Company Age", x="Company Age", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
```

# Team and Project Size
There seems to be no clear relationship between team or project size and salary, other than solo developers and those on
very large project teams (greater than 20 members) tend to make less than the overall median salary.

```{r team_project_size, echo=FALSE}
team_size_summary <- phackers_employed %>% 
  group_by(team_size_f) %>% 
  summarise(y=median(salary_numeric), n=n(), percent=round(100*n()/sum(count(phackers)),2),
            lower=quantile(salary_numeric, 0.25),
            upper=quantile(salary_numeric, 0.75))

team_size_boxplot <- phackers_employed %>% 
  ggplot(aes(x=team_size_f, y=salary_numeric, fill=team_size_f)) +
  median_hline + 
  geom_boxplot() + 
  guides(fill="none") + 
  labs(title="Team Size", x="Team size", y="Salary Range")

team_size_summary %>% ggplot(aes(x=team_size_f, fill=team_size_f, y=y, ymin=lower, ymax=upper)) +
  median_hline +
  geom_crossbar(alpha=0.5, color="white") + 
  # geom_linerange(size=5) +
  # geom_point(shape='|', size=5, stroke=2, color="white" )  +
  labs(title="Team Size", x="Team Size", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
  
project_size_summary <- phackers_employed %>% group_by(project_size_f) %>% 
  summarise(y=median(salary_numeric), 
            n=n(), 
            percent=round(100*n()/sum(count(phackers)),2),
            lower=quantile(salary_numeric, 0.25),
            upper=quantile(salary_numeric, 0.75))

project_size_boxplot <- phackers_employed %>%
  ggplot(aes(x=project_size_f, y=salary_numeric, fill=project_size_f)) + 
  median_hline + 
  geom_boxplot() + 
  guides(fill="none") +
  labs(title="Project Size", x="Project Size", y="Salary Range")

project_size_summary %>% ggplot(aes(x=project_size_f, fill=project_size_f, y=y, ymin=lower, ymax=upper)) +
  median_hline +
  # geom_linerange(size=5) +
  geom_crossbar(alpha=0.5, color="white") + 
  labs(title="Project Size", x="Project Size", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
```

# Freelance and Independent Contractors

Freelancers or independent contractors made up only 10% of the respondents. As a group, however, their median income is Php 10,000 above that of company employees.

```{r employment, echo=FALSE}
freelance_salary_summary <- phackers %>% group_by(employment_f) %>% 
  summarise(median_salary=median(salary_numeric), 
            n=n(), 
            percent=round(100 * n()/sum(count(phackers)),2),
            lower=quantile(salary_numeric, 0.25), 
            upper=quantile(salary_numeric, 0.75))

freelance_salary_summary %>% ggplot(aes(x=employment_f, fill=employment_f, y=median_salary, ymin=lower, ymax=upper)) +
  median_hline +
  geom_crossbar(alpha=0.5, color="white") +
  labs(title="Employment", x="Employment", y="Salary Range") + 
  scale_y_continuous(breaks = seq(20000,200000,by=20000), labels=function(sal) {sprintf("%.0fK", sal / 1000)}) + 
  guides(fill="none") +
  coord_flip()
```


```{r, echo=FALSE}
phackers_freelance = phackers %>% filter(employment_f == "Freelance")

phackers_freelance_summary <- phackers_freelance %>%  group_by(company_industry_f) %>% 
  summarise(median=median(salary_numeric), n=n(), pct=round(100*n()/sum(count(phackers_freelance)),2)) %>% 
  arrange(desc(pct)) %>%
  rename("Industry"=company_industry_f, percentage=pct) %>% 
  top_n(n=10, wt=percentage)

# phackers_freelance_summary
```

```{r, echo=FALSE, message=FALSE}
d <- phackers %>% select(salary_numeric, ncr, employment_f)
model = lm(salary_numeric ~ ., data=d)
```